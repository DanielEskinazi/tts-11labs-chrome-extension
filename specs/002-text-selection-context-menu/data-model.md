# Data Model: Text Selection and Context Menu Integration

**Feature**: Phase 2 - Text Selection and Context Menu Integration
**Date**: 2025-10-17
**Status**: Complete
**Related**: [spec.md](./spec.md) | [plan.md](./plan.md) | [research.md](./research.md)

## Overview

This document defines all data entities used in Phase 2 of the ElevenLabs TTS Chrome Extension. Each entity includes attributes, validation rules, relationships to other entities, and state transitions where applicable.

---

## Entity 1: SelectedText

### Description

Represents the text content selected by the user on a web page. This is the primary data entity in Phase 2, capturing what the user wants to convert to speech (Phase 3 will perform the actual conversion).

### Attributes

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| `text` | string | Yes | The raw text content selected by the user. UTF-8 encoded, may contain Unicode characters, emojis, special characters. |
| `length` | integer | Yes | Number of characters in the text (computed from `text.length`). Used for validation and warnings. |
| `url` | string | Yes | The full URL of the page where text was selected. Format: valid HTTP/HTTPS URL (e.g., "https://example.com/page"). |
| `timestamp` | number | Yes | Unix timestamp in milliseconds when text was captured. Format: `Date.now()` (e.g., 1729180800000). |
| `selectionRange` | object | No | Internal browser representation of the selection (DOM Range object). Used by content script only, not serialized in messages. |

### Validation Rules

1. **text**:
   - MUST NOT be empty string after trimming whitespace
   - MUST NOT be only whitespace characters
   - Maximum length: 10,000 characters (warning shown to user if exceeded)
   - Characters allowed: Any valid UTF-8 character
   - HTML tags: Should be stripped if present (content script gets rendered text via `window.getSelection().toString()`)

2. **length**:
   - MUST be computed as `text.length` (JavaScript string length)
   - Minimum: 1 character
   - Maximum: 10,000 characters (warning threshold)

3. **url**:
   - MUST be valid HTTP or HTTPS URL
   - MUST match pattern: `^https?://.*`
   - MUST come from `window.location.href` (trusted source)
   - Maximum length: 2048 characters (browser URL limit)

4. **timestamp**:
   - MUST be valid Unix timestamp (milliseconds)
   - MUST be generated by `Date.now()`
   - Range: reasonable current time ¬±1 hour (sanity check)

5. **selectionRange**:
   - Optional field (internal use only)
   - Type: DOM Range object from `window.getSelection().getRangeAt(0)`
   - Not validated (browser-generated)

### Relationships

- **Created by**: Content script (content.js) when user clicks context menu
- **Sent to**: Background service worker (background.js) via chrome.runtime.sendMessage
- **Stored in**: chrome.storage.session (persists across service worker restarts)
- **Used by**: Phase 3 will send this text to ElevenLabs API

### State Transitions

```
[User selects text]
    ‚Üì
[INITIAL] - Text highlighted in browser, not yet captured
    ‚Üì (User clicks "Read with ElevenLabs" context menu)
[CAPTURING] - Content script extracts text via window.getSelection()
    ‚Üì (Validation and trimming)
[VALID] - Text passes validation, ready to send
    ‚Üì (chrome.runtime.sendMessage)
[SENT] - Message sent to service worker
    ‚Üì (Service worker receives and stores)
[STORED] - Text stored in chrome.storage.session
    ‚Üì (Phase 3: Send to API)
[PROCESSED] - Text sent to ElevenLabs API (Phase 3)
    ‚Üì (User closes browser or selects new text)
[EXPIRED] - Storage cleared (browser close or new selection)
```

### Example Instances

**Example 1: Short text selection**
```json
{
  "text": "The quick brown fox jumps over the lazy dog.",
  "length": 44,
  "url": "https://example.com/article",
  "timestamp": 1729180800000
}
```

**Example 2: Text with Unicode/emoji**
```json
{
  "text": "Hello ‰∏ñÁïå! üåç Testing Unicode support.",
  "length": 35,
  "url": "https://blog.example.com/2024/unicode",
  "timestamp": 1729180850000
}
```

**Example 3: Long text (warning threshold)**
```json
{
  "text": "Lorem ipsum dolor sit amet... [9,950 more characters]",
  "length": 10000,
  "url": "https://news.example.com/long-article",
  "timestamp": 1729180900000
}
```

**Example 4: Multi-paragraph selection**
```json
{
  "text": "First paragraph with some content.\n\nSecond paragraph after line break.\n\nThird paragraph.",
  "length": 95,
  "url": "https://docs.example.com/guide",
  "timestamp": 1729180950000
}
```

---

## Entity 2: ContextMenuItem

### Description

Represents the "Read with ElevenLabs" option in the browser's right-click context menu. This is the primary user interface element for triggering text-to-speech functionality.

### Attributes

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| `id` | string | Yes | Unique identifier for the menu item. Value: "read-with-elevenlabs". |
| `title` | string | Yes | Display text shown in the context menu. Value: "Read with ElevenLabs". |
| `contexts` | array\<string\> | Yes | When to show the menu item. Value: ["selection"] (only when text is selected). |
| `documentUrlPatterns` | array\<string\> | Yes | URL patterns where menu should appear. Value: ["http://*/*", "https://*/*"]. |
| `visible` | boolean | No | Whether menu item is currently visible. Managed automatically by Chrome based on `contexts`. |
| `enabled` | boolean | No | Whether menu item is clickable. Always true in Phase 2 (Phase 3 may disable if API key missing). |

### Validation Rules

1. **id**:
   - MUST be unique across all context menu items in extension
   - MUST be lowercase with hyphens (kebab-case)
   - Pattern: `^[a-z0-9-]+$`

2. **title**:
   - MUST NOT be empty string
   - Maximum length: 100 characters (Chrome limit)
   - SHOULD be concise and descriptive

3. **contexts**:
   - MUST be non-empty array
   - Valid values: "selection", "page", "link", "image", etc. (Phase 2 uses only "selection")
   - Chrome automatically hides menu if context doesn't match

4. **documentUrlPatterns**:
   - MUST be valid URL match patterns
   - Phase 2 uses: ["http://*/*", "https://*/*"] (all HTTP/HTTPS pages)
   - Excludes: chrome://, chrome-extension://, file:// (Chrome restriction)

### Relationships

- **Created by**: Background service worker on extension install (chrome.runtime.onInstalled)
- **Triggers**: Message to content script to capture selected text
- **Visibility controlled by**: Chrome browser (based on `contexts` and user's selection state)

### State Transitions

```
[Extension installed]
    ‚Üì
[REGISTERED] - Menu item created via chrome.contextMenus.create()
    ‚Üì (User selects text on page)
[VISIBLE] - Chrome shows menu item in context menu
    ‚Üì (User clicks menu item)
[CLICKED] - chrome.contextMenus.onClicked fires
    ‚Üì (Service worker sends message to content script)
[PROCESSING] - Content script captures text
    ‚Üì (User deselects text or closes menu)
[HIDDEN] - Menu item no longer visible
    ‚Üì (Loop back to VISIBLE when text selected again)
```

### Example Configuration

```javascript
// background.js - Context menu creation
chrome.contextMenus.create({
  id: "read-with-elevenlabs",
  title: "Read with ElevenLabs",
  contexts: ["selection"],
  documentUrlPatterns: ["http://*/*", "https://*/*"]
});
```

### User Experience

- **Appearance**: Menu item appears in standard Chrome context menu with extension icon (16x16)
- **Position**: Inserted by Chrome in context menu, typically near other extension items
- **Behavior**: Single click triggers text capture and toast notification
- **Feedback**: Toast notification confirms action (see ToastNotification entity)

---

## Entity 3: ToastNotification

### Description

Represents a temporary visual feedback element shown to the user after text is successfully captured. Displayed for 3 seconds with a fade-in/fade-out animation.

### Attributes

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| `message` | string | Yes | The text content displayed in the toast. Format: "Text captured: [first 30 chars]..." |
| `type` | string | Yes | Toast type for styling. Values: "success" (green), "warning" (yellow), "error" (red). Phase 2 uses "success" primarily. |
| `duration` | number | Yes | How long to display the toast in milliseconds. Default: 3000 (3 seconds). |
| `position` | string | Yes | Screen position for the toast. Value: "top-right" (fixed position). |
| `zIndex` | number | Yes | CSS z-index to ensure toast appears above all page content. Value: 2147483647 (max int32). |
| `animation` | string | Yes | CSS animation name for entrance. Value: "slideIn". |
| `timestamp` | number | Yes | When the toast was created. Format: Unix timestamp in milliseconds. |

### Validation Rules

1. **message**:
   - MUST NOT be empty string
   - Maximum length: 200 characters (keep toast compact)
   - MUST be HTML-escaped to prevent XSS
   - Format: "Text captured: " + first 30 chars of selected text + "..." (if truncated)

2. **type**:
   - MUST be one of: "success", "warning", "error"
   - Phase 2 primary type: "success" (green background)
   - Phase 2 secondary type: "warning" (yellow background for long text)

3. **duration**:
   - MUST be positive integer
   - Minimum: 1000ms (1 second)
   - Maximum: 10000ms (10 seconds)
   - Default: 3000ms (3 seconds)

4. **position**:
   - MUST be one of: "top-right", "top-left", "bottom-right", "bottom-left", "top-center", "bottom-center"
   - Phase 2 uses: "top-right" (consistent with browser notification patterns)

5. **zIndex**:
   - MUST be positive integer
   - Recommended: 2147483647 (max 32-bit integer) to ensure visibility

6. **animation**:
   - MUST reference valid CSS animation name
   - Phase 2 uses: "slideIn" (slide from right with fade)

### Relationships

- **Created by**: Content script (content.js) when text capture confirmation received from service worker
- **Displayed in**: Shadow DOM attached to page document.body
- **Styled by**: toast.css (injected into shadow root)
- **Triggered by**: Message from service worker with type "SHOW_TOAST"

### State Transitions

```
[Service worker confirms text captured]
    ‚Üì
[CREATED] - Toast container and shadow root created
    ‚Üì (Shadow DOM content injected)
[INJECTED] - Toast HTML and CSS added to shadow root
    ‚Üì (Container appended to document.body)
[VISIBLE] - Toast animates in (slideIn animation, 300ms)
    ‚Üì (Wait for duration - 3000ms)
[DISPLAYING] - Toast fully visible, countdown started
    ‚Üì (Duration expires)
[FADING] - Toast fades out (optional fade-out animation)
    ‚Üì (Container removed from DOM)
[REMOVED] - Toast container removed, shadow root destroyed
```

### Styling (CSS)

```css
/* Injected into Shadow DOM */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #10b981; /* Green for success */
  color: white;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 2147483647;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  font-weight: 500;
  max-width: 400px;
  word-wrap: break-word;
  animation: slideIn 0.3s ease-out;
}

.toast.warning {
  background: #f59e0b; /* Yellow for warning */
}

.toast.error {
  background: #ef4444; /* Red for error */
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
```

### Example Instances

**Example 1: Success toast (short text)**
```json
{
  "message": "Text captured: The quick brown fox jumps...",
  "type": "success",
  "duration": 3000,
  "position": "top-right",
  "zIndex": 2147483647,
  "animation": "slideIn",
  "timestamp": 1729180800100
}
```

**Example 2: Warning toast (long text)**
```json
{
  "message": "Text is very long (9,850 chars), this may take a while",
  "type": "warning",
  "duration": 3000,
  "position": "top-right",
  "zIndex": 2147483647,
  "animation": "slideIn",
  "timestamp": 1729180850200
}
```

**Example 3: Error toast (Phase 3)**
```json
{
  "message": "Failed to capture text. Please try again.",
  "type": "error",
  "duration": 3000,
  "position": "top-right",
  "zIndex": 2147483647,
  "animation": "slideIn",
  "timestamp": 1729180900300
}
```

### Accessibility

- **ARIA Attributes**:
  - `role="alert"` - Indicates important message
  - `aria-live="polite"` - Screen reader announces without interrupting
- **Visual**: High contrast (white text on colored background)
- **Duration**: 3 seconds provides adequate time to read short message

---

## Entity 4: Message

### Description

Represents a message passed between content script and background service worker using Chrome's message passing API (chrome.runtime.sendMessage/onMessage).

### Attributes

| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| `type` | string | Yes | Message type identifier. Values: "CAPTURE_TEXT", "TEXT_CAPTURED", "SHOW_TOAST". |
| `payload` | object \| null | No | Message-specific data. Structure depends on `type`. See payload schemas below. |
| `timestamp` | number | Yes | When message was created. Format: Unix timestamp in milliseconds. |
| `sender` | string | No | Component that sent the message. Values: "content-script", "service-worker". For debugging only. |

### Validation Rules

1. **type**:
   - MUST NOT be empty string
   - MUST be one of the defined message types (see Message Types section)
   - Convention: UPPERCASE_WITH_UNDERSCORES

2. **payload**:
   - MUST be valid JSON-serializable object (no functions, circular references)
   - May be null for messages without data
   - Structure validated based on message type

3. **timestamp**:
   - MUST be valid Unix timestamp (milliseconds)
   - MUST be generated by `Date.now()`

4. **sender**:
   - Optional field for debugging
   - Not validated (informational only)

### Message Types

#### Type 1: CAPTURE_TEXT

**Direction**: Service worker ‚Üí Content script
**Purpose**: Instruct content script to capture currently selected text
**Payload**: null

```json
{
  "type": "CAPTURE_TEXT",
  "payload": null,
  "timestamp": 1729180800000
}
```

#### Type 2: TEXT_CAPTURED

**Direction**: Content script ‚Üí Service worker
**Purpose**: Send captured text to service worker for storage
**Payload**:
```typescript
{
  text: string,      // The captured text (trimmed)
  url: string,       // Page URL where text was selected
  length: number     // Text length in characters
}
```

**Example**:
```json
{
  "type": "TEXT_CAPTURED",
  "payload": {
    "text": "The quick brown fox jumps over the lazy dog.",
    "url": "https://example.com/article",
    "length": 44
  },
  "timestamp": 1729180800100
}
```

#### Type 3: SHOW_TOAST

**Direction**: Service worker ‚Üí Content script
**Purpose**: Instruct content script to display toast notification
**Payload**:
```typescript
{
  message: string,   // Toast message to display
  type: string       // Toast type: "success", "warning", "error"
}
```

**Example**:
```json
{
  "type": "SHOW_TOAST",
  "payload": {
    "message": "Text captured: The quick brown fox jumps...",
    "type": "success"
  },
  "timestamp": 1729180800200
}
```

### Relationships

- **Sent by**: Content script or service worker
- **Received by**: Content script or service worker (opposite of sender)
- **Transport**: chrome.runtime.sendMessage / chrome.runtime.onMessage
- **Lifetime**: Single use (not stored after delivery)

### State Transitions

```
[Message created in sender]
    ‚Üì
[PENDING] - Message object constructed, ready to send
    ‚Üì (chrome.runtime.sendMessage called)
[SENT] - Message serialized and sent via Chrome IPC
    ‚Üì (Chrome delivers message to receiver)
[RECEIVED] - chrome.runtime.onMessage fires in receiver
    ‚Üì (Handler processes message)
[PROCESSED] - Message handler completes
    ‚Üì
[COMPLETED] - Message lifecycle ends (no persistence)
```

### Error Handling

**Error Case 1: Receiver not available**
- **Cause**: Service worker terminated or content script not loaded
- **Detection**: chrome.runtime.sendMessage Promise rejects with "Receiving end does not exist"
- **Handling**: Log error, show error toast to user

**Error Case 2: Invalid message format**
- **Cause**: Missing required fields (type, timestamp) or invalid payload
- **Detection**: Validation check in message handler
- **Handling**: Log warning, ignore message

**Error Case 3: Unknown message type**
- **Cause**: Message type not recognized by receiver
- **Detection**: Switch/case in message handler doesn't match
- **Handling**: Log warning, ignore message (graceful degradation)

### Example Message Flows

**Flow 1: Text capture (happy path)**
```
1. User clicks context menu
   ‚Üí Service worker: chrome.contextMenus.onClicked fires

2. Service worker ‚Üí Content script: CAPTURE_TEXT
   {
     "type": "CAPTURE_TEXT",
     "payload": null,
     "timestamp": 1729180800000
   }

3. Content script extracts text, sends to service worker
   Content script ‚Üí Service worker: TEXT_CAPTURED
   {
     "type": "TEXT_CAPTURED",
     "payload": {
       "text": "Selected text content...",
       "url": "https://example.com/page",
       "length": 150
     },
     "timestamp": 1729180800100
   }

4. Service worker stores text, sends toast confirmation
   Service worker ‚Üí Content script: SHOW_TOAST
   {
     "type": "SHOW_TOAST",
     "payload": {
       "message": "Text captured: Selected text content...",
       "type": "success"
     },
     "timestamp": 1729180800200
   }

5. Content script displays toast for 3 seconds
```

**Flow 2: Long text warning**
```
1-3. Same as Flow 1, but text.length > 5000

4. Service worker sends warning toast
   Service worker ‚Üí Content script: SHOW_TOAST
   {
     "type": "SHOW_TOAST",
     "payload": {
       "message": "Text is very long (8,450 chars), this may take a while",
       "type": "warning"
     },
     "timestamp": 1729180800200
   }
```

---

## Entity Relationships Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SelectedText    ‚îÇ
‚îÇ                  ‚îÇ
‚îÇ  - text          ‚îÇ
‚îÇ  - length        ‚îÇ
‚îÇ  - url           ‚îÇ
‚îÇ  - timestamp     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ captured by
         ‚îÇ
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      triggers       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ContextMenuItem  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ‚îÇ  Message         ‚îÇ
‚îÇ                  ‚îÇ                     ‚îÇ                  ‚îÇ
‚îÇ  - id            ‚îÇ                     ‚îÇ  - type          ‚îÇ
‚îÇ  - title         ‚îÇ                     ‚îÇ  - payload       ‚îÇ
‚îÇ  - contexts      ‚îÇ                     ‚îÇ  - timestamp     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                  ‚îÇ
                                                  ‚îÇ triggers
                                                  ‚îÇ
                                                  ‚Üì
                                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                         ‚îÇ ToastNotification‚îÇ
                                         ‚îÇ                  ‚îÇ
                                         ‚îÇ  - message       ‚îÇ
                                         ‚îÇ  - type          ‚îÇ
                                         ‚îÇ  - duration      ‚îÇ
                                         ‚îÇ  - position      ‚îÇ
                                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Storage Schema

### chrome.storage.session

**Key**: `lastCapturedText`
**Type**: SelectedText (see Entity 1)
**Lifetime**: Browser session (clears on browser close)
**Size**: ~500 bytes to 30KB (depending on text length)

**Example**:
```json
{
  "lastCapturedText": {
    "text": "The quick brown fox jumps over the lazy dog.",
    "length": 44,
    "url": "https://example.com/article",
    "timestamp": 1729180800000
  }
}
```

### In-Memory Cache (Service Worker)

**Variable**: `capturedTextCache`
**Type**: SelectedText | null
**Lifetime**: Until service worker terminates (~30 seconds of inactivity)
**Purpose**: Fast access to last captured text without I/O

**Example**:
```javascript
let capturedTextCache = {
  text: "The quick brown fox jumps over the lazy dog.",
  length: 44,
  url: "https://example.com/article",
  timestamp: 1729180800000
};
```

---

## Data Validation Summary

| Entity | Key Validations | Error Handling |
|--------|----------------|----------------|
| **SelectedText** | Non-empty after trim, length ‚â§10,000, valid URL | Show error toast, log to console |
| **ContextMenuItem** | Valid ID, non-empty title, valid contexts | Extension install fails (caught by Chrome) |
| **ToastNotification** | HTML-escaped message, valid type, duration >0 | Log warning, use defaults |
| **Message** | Valid type, serializable payload, timestamp present | Ignore invalid messages, log warning |

---

## Performance Considerations

1. **SelectedText**: Large text (10,000+ chars) stored in chrome.storage.session is fast (~5-10ms write time) but should be warned to user

2. **ToastNotification**: Shadow DOM creation overhead is minimal (~2ms), no performance concern

3. **Message**: Message passing overhead is ~5-10ms per message (same process IPC), acceptable for Phase 2 UX requirements

4. **Storage**: chrome.storage.session has 10MB limit, easily accommodates Phase 2 needs (max ~30KB per text capture)

---

## Next Steps

1. Review this data model for approval
2. Implement contracts (message-schema.json, toast-api.json)
3. Implement entities in source code (background.js, content.js)
4. Add validation logic for all entities
5. Test edge cases (empty text, long text, special characters, etc.)

---

**Document Status**: ‚úÖ Complete
**Last Updated**: 2025-10-17
**Next Phase**: Contracts (message-schema.json, toast-api.json)
