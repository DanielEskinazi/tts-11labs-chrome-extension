# Implementation Plan: Real-time Text Highlighting

**Branch**: `007-text-highlighting` | **Date**: 2025-10-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-text-highlighting/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implement sentence-by-sentence text highlighting synchronized with audio playback. As the ElevenLabs TTS reads selected text, each sentence is highlighted in sequence with a visible background color. Includes auto-scroll to keep highlighted text visible and playback speed integration for accurate timing adjustment.

## Technical Context

**Language/Version**: JavaScript ES2020+ (Chrome extension runtime environment)
**Primary Dependencies**: None (vanilla JavaScript, uses built-in Chrome APIs and DOM APIs)
**Storage**: chrome.storage.session for playback state tracking (if needed), no persistent storage for highlights
**Testing**: Manual testing in Chrome browser (per constitution requirement)
**Target Platform**: Chrome 88+ (Manifest V3 minimum)
**Project Type**: Chrome extension (single project, content script for DOM manipulation)
**Performance Goals**: <200ms highlight synchronization accuracy, 60fps smooth transitions, instant highlight clear (<100ms)
**Constraints**: No page layout breakage, graceful degradation if DOM changes, minimal performance impact on page
**Scale/Scope**: Works across all websites, handles long passages (100+ sentences), supports dynamic content

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Phase-First Development ✅

**Status**: PASS
- Feature will be implemented in discrete phases: sentence parsing → highlighting → auto-scroll → speed integration
- Each phase is independently testable in Chrome
- Incremental value delivery (basic highlighting works before auto-scroll)

### II. Manifest V3 Compliance ✅

**Status**: PASS
- No new permissions required (content script already has page DOM access)
- Uses content script for DOM manipulation (sentence highlighting)
- Message passing via chrome.runtime for playback event synchronization
- No blocking APIs or persistent background pages

### III. Security & Privacy First ✅

**Status**: PASS
- No API keys or sensitive data involved
- No data storage or transmission to external services
- Only visual DOM manipulation (temporary highlight styling)
- No privacy implications

### IV. Chrome Extension Best Practices ✅

**Status**: PASS
- Content script handles all highlighting logic (page DOM interaction)
- Background/offscreen scripts communicate playback events via messages
- Proper cleanup: removes highlights on stop, clears event listeners
- Lightweight implementation (<5KB code, no external libraries)

### V. Testing Before Proceeding ✅

**Status**: PASS
- Manual testing plan defined for each phase
- Will test on 3+ websites (news articles, documentation, blogs)
- Test scenarios cover: short/long sentences, pause/resume, speed changes
- Performance validation (smooth transitions, no layout breaks)

**GATE RESULT**: ALL GATES PASS - Proceed to Phase 0 Research

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
/ (repository root)
├── manifest.json           # Chrome extension manifest (no changes needed)
├── content.js              # ⭐ ADD: Highlighting logic here
├── background.js           # MODIFY: Send timing/state messages to content script
├── offscreen.js            # MODIFY: Send playback progress events
├── popup.html              # No changes
├── popup.js                # No changes
├── popup.css               # No changes
├── src/
│   ├── api/
│   │   └── elevenlabs.js   # No changes
│   └── utils/
│       ├── storage.js      # No changes
│       └── textUtils.js    # ⭐ NEW: Sentence splitting utilities
└── specs/
    └── 007-text-highlighting/
        ├── spec.md
        ├── plan.md (this file)
        ├── research.md (generated next)
        ├── data-model.md (generated after research)
        ├── quickstart.md (generated after research)
        ├── contracts/ (generated after research)
        └── tasks.md (generated by /speckit.tasks command)
```

**Structure Decision**: Chrome extension with flat structure at repository root. Highlighting logic lives in `content.js` (content script with page DOM access). New utility module `src/utils/textUtils.js` for sentence parsing. Background and offscreen scripts modified to send timing/progress messages to content script for synchronization.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**No violations** - All constitution gates pass. No complexity justifications needed.

---

## Phase Completion Summary

### Phase 0: Research ✅

**Completed**: 2025-10-22

**Artifacts Generated**:
- `research.md` - Technical research on sentence splitting, DOM highlighting, timing synchronization, auto-scroll, and performance optimization

**Key Decisions**:
1. Sentence splitting: Regex-based (`/[.!?]+\s+/g`)
2. DOM highlighting: `<span>` wrapper with CSS class
3. Timing: Proportional character count
4. Auto-scroll: `scrollIntoView` API
5. Performance: Sentence windowing for >100 sentences

**All unknowns resolved** - No NEEDS CLARIFICATION items remaining

---

### Phase 1: Design & Contracts ✅

**Completed**: 2025-10-22

**Artifacts Generated**:
- `data-model.md` - Entity definitions (Sentence, SentenceTiming, Highlight, HighlightState)
- `contracts/messages.md` - Message contracts for inter-script communication (6 message types defined)
- `quickstart.md` - Developer implementation guide with code examples and testing checklist
- `CLAUDE.md` - Updated agent context with new technologies

**Constitution Check (Post-Design)**: ✅ PASS

All gates still pass after design phase:
- ✅ Phase-First Development: Design supports incremental implementation
- ✅ Manifest V3 Compliance: No new permissions, uses content script + message passing
- ✅ Security & Privacy First: No data storage, no external communication
- ✅ Chrome Extension Best Practices: Content script for DOM, message-based sync
- ✅ Testing Before Proceeding: Manual testing plan defined in quickstart.md

**No design changes required** - Architecture aligns with constitution

---

## Next Steps

**Phase 2: Task Generation** (NOT completed by /speckit.plan)

Run `/speckit.tasks` command to generate `tasks.md` with:
- Dependency-ordered implementation tasks
- Test validation criteria
- Parallel execution opportunities

**Phase 3: Implementation**

Run `/speckit.implement` command to execute tasks from `tasks.md`

---

## Generated Artifacts Manifest

```
specs/007-text-highlighting/
├── spec.md ✅                    # Feature specification (pre-existing)
├── plan.md ✅                    # This file (Phase 0-1 planning)
├── research.md ✅                # Phase 0: Technical research
├── data-model.md ✅              # Phase 1: Entity definitions
├── quickstart.md ✅              # Phase 1: Developer guide
├── contracts/
│   └── messages.md ✅            # Phase 1: Message contracts
└── tasks.md ⏳                   # Phase 2: Generated by /speckit.tasks
```

**Status**: Planning complete. Ready for task generation and implementation.

